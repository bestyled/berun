'use strict'
const chalk = require('chalk')
const clearConsole = require('react-dev-utils/clearConsole')
const checkRequiredFiles = require('react-dev-utils/checkRequiredFiles')
const {
  choosePort,
  createCompiler,
  prepareUrls
} = require('react-dev-utils/WebpackDevServerUtils')
const openBrowser = require('react-dev-utils/openBrowser')
const { checkBrowsers } = require('react-dev-utils/browsersHelper')
const verifyPackageTree = require('./utils/verifyPackageTree')
const webpack = require('webpack')
const WebpackDevServer = require('webpack-dev-server')

// MAIN MODULE EXPORTS, WITH DEFAULT FLOW

module.exports = async berun => {
  try {
    await taskDevBuildPreFlightArgs(berun)
    await taskDevBuildPreFlightChecks(berun)
    await taskDevBuildGetPort(berun)
    await taskDevBuildCompile(berun)
  } catch (err) {
    if (err && err.message) {
      console.log(err.message)
    }
    process.exit(1)
  }
}

// EXPORT INDIVIDUAL FUNCTIONS FOR MORE FINE-GRAINED CUSTOM TASKS
// SEE @berun/runner-webpack-static for an example of where these are used

module.exports = Object.assign(module.exports, {
  taskDevBuildPreFlightArgs,
  taskDevBuildPreFlightChecks,
  taskDevBuildGetPort,
  taskDevBuildCompile
})

async function taskDevBuildPreFlightArgs(berun) {
  // Process CLI arguments

  const argv = process.argv.slice(2)

  berun.sparkyContext.debug = argv.indexOf('--debug') !== -1

  berun.sparkyContext.isInteractive = process.stdout.isTTY
}

async function taskDevBuildPreFlightChecks(berun) {
  if (process.env.SKIP_PREFLIGHT_CHECK !== 'true') {
    verifyPackageTree()
    // Warn and crash if required files are missing
    if (
      !checkRequiredFiles([
        //  berun.options.paths.appHtml,
        berun.options.paths.appIndexJs
      ])
    ) {
      process.exit(1)
    }
  }

  if (process.env.HOST) {
    console.log(
      chalk.cyan(
        `Attempting to bind to HOST environment variable: ${chalk.yellow(
          chalk.bold(process.env.HOST)
        )}`
      )
    )
    console.log(
      `If this was unintentional, check that you haven't mistakenly set it in your shell.`
    )
    console.log(
      `Learn more here: ${chalk.yellow('http://bit.ly/CRA-advanced-config')}`
    )
    console.log()
  }

  // We require that you explictly set browsers and do not fall back to
  // browserslist defaults.

  await checkBrowsers(berun.options.paths.appPath)
}

async function taskDevBuildGetPort(berun) {
  // Tools like Cloud9 rely on this.
  const DEFAULT_PORT = parseInt(process.env.PORT, 10) || 3000
  const HOST = process.env.HOST || '0.0.0.0'

  const port = await choosePort(HOST, DEFAULT_PORT)

  if (port == null) {
    throw new Error('Could not find a suitable port')
  }

  const protocol = process.env.HTTPS === 'true' ? 'https' : 'http'

  berun.sparkyContext.url = { protocol, HOST, port }
}

function taskDevBuildCompile(berun) {
  const { protocol, HOST, port } = berun.sparkyContext.url

  const appName = require(berun.options.paths.appPackageJson).name
  const urls = prepareUrls(protocol, HOST, port)

  // Serve webpack assets generated by the compiler over a web server.
  const serverConfig = berun.devserver.toConfig()
  let devServer

  const devSocket = {
    warnings: warnings =>
      devServer.sockWrite(devServer.sockets, 'warnings', warnings),
    errors: errors =>
      devServer.sockWrite(devServer.sockets, 'errors', errors),
  };

  // require('fs').writeFileSync( require('path').join(process.cwd(), '.debug.webpack.dev.js'), 'module.exports=' +   berun.webpack.toString({ configPrefix: 'berun.webpack' })  )
  // Create a webpack compiler that is configured with custom messages.
  const compiler = createCompiler(
    {
      appName,
      config: berun.webpack.toConfig(),
      urls,
      useYarn: berun.options.paths.useYarn,
      webpack,
      useTypeScript: false && berun.options.paths.isTypescript,
      devSocket,
    }
  )

  // require('fs').writeFileSync(require('path').join(process.cwd(), ".debug.webpack.devserver.js"), "module.exports=" + require('util').inspect(berun.devserver.toConfig(), 99));

  devServer = new WebpackDevServer(compiler, serverConfig)

  return new Promise((resolve, reject) => {
    // Launch WebpackDevServer.
    devServer.listen(port, HOST, err => {
      if (err) {
        return console.log(err)
      }
      if (berun.sparkyContext.isInteractive) {
        clearConsole()
      }
      console.log(chalk.cyan('Starting the development server...\n'))
      openBrowser(urls.localUrlForBrowser)
    })
      ;['SIGINT', 'SIGTERM'].forEach(function (sig) {
        process.on(sig, function () {
          devServer.close()
          resolve()
        })
      })
  })
}
